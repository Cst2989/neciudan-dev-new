<div id="overlay"></div>
<div id="dialog">
  <button id="close">âœ•</button>
  <div class="content">
    <img src="/images/logo.png" alt="Author" />
    <h2>Discover more from The Neciu Dan Newsletter</h2>
    <p class="description">A weekly column on Tech & Education, startup building and occasional hot takes.</p>
    <p class="subscribers">Over 1,000 subscribers</p>
    <form id="subscribeForm">
      <input type="email" name="email" placeholder="Type your email..." required />
      <button type="submit" class="submit-btn" disabled={false}>
        <span class="normal-text">Subscribe</span>
        <span class="loading-text hidden">
          <svg class="animate-spin h-5 w-5 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Subscribing...
        </span>
      </button>
    </form>
    <button id="continue">Continue reading</button>
  </div>
</div>

<style>
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    transition: background-color 0.15s linear;
    z-index: 50;
    pointer-events: none;
  }

  #dialog {
    position: fixed;
    left: 50%;
    bottom: 0;
    width: 90%;
    max-width: 500px;
    background: #1e2432;
    padding: 2rem;
    border-radius: 8px;
    color: white;
    transform: translate(-50%, 100%);
    transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    z-index: 51;
  }

  #close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    background: none;
    border: none;
    color: #64748b;
    cursor: pointer;
    padding: 0.5rem;
    font-size: 1.25rem;
  }

  .content {
    text-align: center;
  }

  .content img {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    margin: 0 auto 1rem;
  }

  .content h2 {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .description {
    color: #94a3b8;
    margin-bottom: 1rem;
  }

  .subscribers {
    color: #64748b;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  form {
    margin: 1.5rem 0;
  }

  input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #1a1f2c;
    border: none;
    border-radius: 8px;
    color: white;
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
  }

  button[type='submit'] {
    width: 100%;
    padding: 0.75rem;
    background: #3b82f6;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  button[type='submit']:hover {
    background: #2563eb;
  }

  #continue {
    background: none;
    border: none;
    color: #64748b;
    cursor: pointer;
    font-size: 0.875rem;
  }

  .hidden {
    display: none;
  }

  button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
</style>

<script>
  import Toast from '../Toast';
  
  const overlay = document.getElementById('overlay')!;
  const dialog = document.getElementById('dialog')!;
  let isDialogClosed = false;

  window.addEventListener('scroll', () => {
    // Check if already subscribed
    if (isDialogClosed || localStorage.getItem('newsletterSubscribed') === 'true') {
      return;
    }

    const scrolled = window.scrollY - 1000;
    const headerOffset = 77 + 64;
    const triggerPoint = (window.innerHeight - headerOffset) * 0.3;

    if (scrolled < 0) {
      overlay.style.backgroundColor = 'rgba(0,0,0,0)';
      dialog.style.transform = 'translate(-50%, 100%)';
    } else if (scrolled < triggerPoint) {
      const progress = scrolled / triggerPoint;
      overlay.style.backgroundColor = `rgba(0,0,0,${progress * 0.9})`;
      const translateY = 100 - progress * 150;
      dialog.style.transform = `translate(-50%, ${translateY}%)`;
    } else {
      overlay.style.backgroundColor = 'rgba(0,0,0,0.9)';
      dialog.style.transform = `translate(-50%, -${(window.innerHeight - headerOffset) * 0.25}px)`;
      overlay.style.pointerEvents = 'auto';
    }
  });

  const closeBtn = document.getElementById('close')!;
  const continueBtn = document.getElementById('continue')!;

  function hide() {
    overlay.style.backgroundColor = 'rgba(0,0,0,0)';
    dialog.style.transform = 'translate(-50%, 100%)';
    overlay.style.pointerEvents = 'none';
    isDialogClosed = true;
  }

  closeBtn.addEventListener('click', hide);
  continueBtn.addEventListener('click', hide);
  overlay.addEventListener('click', hide);

  const form = document.getElementById('subscribeForm')!;
  
  // Check if user is already subscribed
  const isSubscribed = localStorage.getItem('newsletterSubscribed') === 'true';
  if (isSubscribed) {
    hide();
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const email = formData.get('email');
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const normalText = submitBtn.querySelector('.normal-text') as HTMLElement;
    const loadingText = submitBtn.querySelector('.loading-text') as HTMLElement;

    // Disable button and show loading state
    submitBtn.disabled = true;
    normalText.classList.add('hidden');
    loadingText.classList.remove('hidden');

    try {
      const response = await fetch('/.netlify/functions/subscribe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Subscription failed');
      }

      localStorage.setItem('newsletterSubscribed', 'true');
      window.dispatchEvent(new CustomEvent('newsletter:subscribed'));
      hide();
      Toast.show('Thank you for subscribing! ðŸŽ‰');
      
    } catch (error) {
      console.error('Subscription error:', error);
      Toast.show('Sorry, there was an error. Please try again later.', 'error');
      
      // Reset button state on error
      submitBtn.disabled = false;
      normalText.classList.remove('hidden');
      loadingText.classList.add('hidden');
    }
  });
</script>
